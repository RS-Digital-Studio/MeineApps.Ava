<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BomberBlast.ViewModels"
             xmlns:conv="using:BomberBlast.Converters"
             xmlns:coreConv="using:MeineApps.Core.Ava.Converters"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             xmlns:controls="using:BomberBlast.Controls"
             xmlns:skia="using:Avalonia.Labs.Controls"
             x:Class="BomberBlast.Views.CollectionView"
             x:DataType="vm:CollectionViewModel"
             x:Name="Collection_Root">

  <!-- Sammlungs-Album: Landscape 2-Spalten Layout -->
  <Panel AutomationProperties.AutomationId="Collection_Root">
    <controls:MenuBackgroundCanvas />

    <Grid ColumnDefinitions="*,1.5*" Margin="16,12,16,80">

      <!-- ═══════════════════════════════════════════════════════════
           LINKE SPALTE (260px) - Navigation + Fortschritt
           ═══════════════════════════════════════════════════════════ -->
      <Grid Grid.Column="0" RowDefinitions="Auto,Auto,Auto,*" Margin="0,0,12,0">

        <!-- Header: Zurück + Titel -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*" Margin="0,0,0,12">
          <Button Grid.Column="0" Classes="Secondary GameButton"
                  Command="{Binding GoBackCommand}"
                  Width="44" Height="44"
                  Padding="0" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                  AutomationProperties.AutomationId="Collection_BtnBack">
            <materialIcons:MaterialIcon Kind="ArrowLeft" Width="22" Height="22"
                                        Foreground="{DynamicResource TextPrimaryBrush}" />
          </Button>
          <TextBlock Grid.Column="1"
                     Text="{Binding Title}"
                     FontSize="22" FontWeight="Bold"
                     Foreground="{DynamicResource AccentBrush}"
                     HorizontalAlignment="Center" VerticalAlignment="Center"
                     AutomationProperties.AutomationId="Collection_TxtTitle" />
        </Grid>

        <!-- Gesamt-Fortschritt -->
        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}"
                CornerRadius="10" Padding="12,8" Margin="0,0,0,12"
                BoxShadow="0 2 8 0 #25000000">
          <StackPanel Spacing="6">
            <TextBlock Text="{Binding TotalProgressText}"
                       FontSize="16" FontWeight="Bold"
                       Foreground="#FFD700" HorizontalAlignment="Center" />
            <ProgressBar Value="{Binding TotalProgressPercent}" Maximum="100"
                         Foreground="#FFD700" Height="10" CornerRadius="5" />
          </StackPanel>
        </Border>

        <!-- 5 Kategorie-Tabs -->
        <StackPanel Grid.Row="2" Spacing="4" Margin="0,0,0,12">

          <!-- Tab 0: Gegner (aktiv: roter linker Akzent) -->
          <Button Classes="Text" Padding="0" HorizontalAlignment="Stretch"
                  Command="{Binding SelectCategoryCommand}" CommandParameter="0">
            <Panel>
              <Border CornerRadius="8" Background="#40FFFFFF"
                      BorderThickness="3,0,0,0" BorderBrush="#F44336"
                      IsVisible="{Binding IsCategory0Active}" />
              <Border CornerRadius="8" Padding="10,8">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Kind="Sword" Width="20" Height="20" Foreground="#F44336" />
                  <TextBlock Text="{Binding CategoryName0}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                </StackPanel>
              </Border>
            </Panel>
          </Button>

          <!-- Tab 1: Bosse (aktiv: goldener linker Akzent) -->
          <Button Classes="Text" Padding="0" HorizontalAlignment="Stretch"
                  Command="{Binding SelectCategoryCommand}" CommandParameter="1">
            <Panel>
              <Border CornerRadius="8" Background="#40FFFFFF"
                      BorderThickness="3,0,0,0" BorderBrush="#FFD700"
                      IsVisible="{Binding IsCategory1Active}" />
              <Border CornerRadius="8" Padding="10,8">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Kind="Crown" Width="20" Height="20" Foreground="#FFD700" />
                  <TextBlock Text="{Binding CategoryName1}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                </StackPanel>
              </Border>
            </Panel>
          </Button>

          <!-- Tab 2: PowerUps (aktiv: grüner linker Akzent) -->
          <Button Classes="Text" Padding="0" HorizontalAlignment="Stretch"
                  Command="{Binding SelectCategoryCommand}" CommandParameter="2">
            <Panel>
              <Border CornerRadius="8" Background="#40FFFFFF"
                      BorderThickness="3,0,0,0" BorderBrush="#4CAF50"
                      IsVisible="{Binding IsCategory2Active}" />
              <Border CornerRadius="8" Padding="10,8">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Kind="Flash" Width="20" Height="20" Foreground="#4CAF50" />
                  <TextBlock Text="{Binding CategoryName2}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                </StackPanel>
              </Border>
            </Panel>
          </Button>

          <!-- Tab 3: Karten (aktiv: blauer linker Akzent) -->
          <Button Classes="Text" Padding="0" HorizontalAlignment="Stretch"
                  Command="{Binding SelectCategoryCommand}" CommandParameter="3">
            <Panel>
              <Border CornerRadius="8" Background="#40FFFFFF"
                      BorderThickness="3,0,0,0" BorderBrush="#2196F3"
                      IsVisible="{Binding IsCategory3Active}" />
              <Border CornerRadius="8" Padding="10,8">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Kind="CardsPlaying" Width="20" Height="20" Foreground="#2196F3" />
                  <TextBlock Text="{Binding CategoryName3}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                </StackPanel>
              </Border>
            </Panel>
          </Button>

          <!-- Tab 4: Kosmetik (aktiv: violetter linker Akzent) -->
          <Button Classes="Text" Padding="0" HorizontalAlignment="Stretch"
                  Command="{Binding SelectCategoryCommand}" CommandParameter="4">
            <Panel>
              <Border CornerRadius="8" Background="#40FFFFFF"
                      BorderThickness="3,0,0,0" BorderBrush="#9C27B0"
                      IsVisible="{Binding IsCategory4Active}" />
              <Border CornerRadius="8" Padding="10,8">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Kind="Palette" Width="20" Height="20" Foreground="#9C27B0" />
                  <TextBlock Text="{Binding CategoryName4}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
                </StackPanel>
              </Border>
            </Panel>
          </Button>
        </StackPanel>

        <!-- Meilensteine -->
        <ScrollViewer Grid.Row="3" VerticalScrollBarVisibility="Auto">
          <ItemsControl ItemsSource="{Binding Milestones}" Margin="0,0,0,8">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <StackPanel Spacing="6" />
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:MilestoneDisplayItem">
                <Border Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="8" Padding="10,8"
                        BoxShadow="0 1 4 0 #20000000">
                  <StackPanel Spacing="4">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      <!-- Prozent-Label -->
                      <Border Grid.Column="0" CornerRadius="6" Padding="8,4"
                              Margin="0,0,8,0" VerticalAlignment="Center">
                        <Border.Background>
                          <SolidColorBrush Color="#FFD700" Opacity="0.15" />
                        </Border.Background>
                        <TextBlock Text="{Binding PercentLabel}"
                                   FontSize="14" FontWeight="Bold" Foreground="#FFD700" />
                      </Border>

                      <!-- Belohnungstext (fett für bessere Sichtbarkeit) -->
                      <TextBlock Grid.Column="1"
                                 Text="{Binding RewardText}"
                                 FontSize="12" FontWeight="Bold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 TextTrimming="CharacterEllipsis"
                                 VerticalAlignment="Center" />

                      <!-- Status: Claim / Claimed / Locked -->
                      <Panel Grid.Column="2" VerticalAlignment="Center" Margin="6,0,0,0">
                        <!-- Einfordern-Button -->
                        <Panel MinHeight="30" IsVisible="{Binding CanClaim}">
                          <controls:GameButtonCanvas ButtonColor="#22C55E" DamageLevel="0.3" ButtonSeed="150" />
                          <Button Classes="Primary GameButton"
                                  Command="{Binding #Collection_Root.DataContext.ClaimMilestoneCommand}"
                                  CommandParameter="{Binding}"
                                  Height="30" Padding="10,0"
                                  Background="Transparent"
                                  Foreground="White">
                            <TextBlock Text="{Binding ClaimText}"
                                       FontSize="11" FontWeight="Bold" Foreground="White" />
                          </Button>
                        </Panel>
                        <!-- Eingefordert -->
                        <materialIcons:MaterialIcon Kind="CheckCircle"
                                                    Width="24" Height="24" Foreground="#22C55E"
                                                    IsVisible="{Binding IsClaimed}" />
                        <!-- Gesperrt -->
                        <materialIcons:MaterialIcon Kind="Lock"
                                                    Width="20" Height="20"
                                                    Foreground="{DynamicResource TextMutedBrush}"
                                                    IsVisible="{Binding IsLocked}" />
                      </Panel>
                    </Grid>
                    <!-- Meilenstein-Fortschrittsbalken -->
                    <ProgressBar Value="{Binding MilestoneProgressPercent}" Maximum="100"
                                 Foreground="#FFD700" Height="3" CornerRadius="2"
                                 IsVisible="{Binding IsLocked}" />
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>

      <!-- ═══════════════════════════════════════════════════════════
           RECHTE SPALTE (*) - Items + Detail
           ═══════════════════════════════════════════════════════════ -->
      <Grid Grid.Column="1" RowDefinitions="Auto,*">

        <!-- Kategorie-Header mit Fortschrittsbalken -->
        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}"
                CornerRadius="10" Padding="12,8" Margin="0,0,0,8"
                BoxShadow="0 2 8 0 #25000000">
          <StackPanel Spacing="6">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Grid.Column="0"
                         Text="{Binding SelectedCategoryName}"
                         FontSize="16" FontWeight="Bold"
                         Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" />
              <TextBlock Grid.Column="1"
                         Text="{Binding ProgressText}"
                         FontSize="14" FontWeight="SemiBold"
                         Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center" />
            </Grid>
            <!-- Kategorie-Fortschrittsbalken -->
            <ProgressBar Value="{Binding CategoryProgressPercent}" Maximum="100"
                         Foreground="{DynamicResource AccentBrush}" Height="4" CornerRadius="2" />
          </StackPanel>
        </Border>

        <!-- Items + Detail -->
        <Panel Grid.Row="1">

          <!-- Empty State (keine Items in Kategorie) -->
          <StackPanel IsVisible="{Binding !Items.Count}"
                      VerticalAlignment="Center"
                      HorizontalAlignment="Center"
                      Spacing="12">
            <materialIcons:MaterialIcon Kind="BookOpenBlankVariant" Width="48" Height="48"
                                        Foreground="{DynamicResource TextMutedBrush}"
                                        HorizontalAlignment="Center" />
            <TextBlock Text="{Binding EmptyItemsText, FallbackValue='Noch nichts entdeckt'}"
                       FontSize="15"
                       Foreground="{DynamicResource TextMutedBrush}"
                       HorizontalAlignment="Center" />
          </StackPanel>

          <!-- Items-Grid (Premium-Karten-Design wie DeckView) -->
          <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                        IsVisible="{Binding Items.Count}">
            <ItemsControl ItemsSource="{Binding Items}"
                          AutomationProperties.AutomationId="Collection_ItemGrid"
                          Margin="0,0,0,8">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:CollectionDisplayItem">
                  <Button Classes="Text" Padding="0" Margin="3"
                          Width="130" Height="190"
                          Command="{Binding #Collection_Root.DataContext.SelectItemCommand}"
                          CommandParameter="{Binding}">
                    <!-- Karten-Tile: Premium mit Kategorie-Border -->
                    <Border CornerRadius="14" Padding="0"
                            ClipToBounds="True"
                            BoxShadow="0 3 12 0 #35000000">
                      <Border.BorderBrush>
                        <SolidColorBrush Color="{Binding BadgeColor}"
                                         Opacity="{Binding BorderOpacity}" />
                      </Border.BorderBrush>
                      <Border.BorderThickness>3</Border.BorderThickness>
                      <Panel>
                        <!-- Basis-Hintergrund mit Gradient -->
                        <Border CornerRadius="11">
                          <Border.Background>
                            <LinearGradientBrush StartPoint="0%,0%" EndPoint="0%,100%">
                              <GradientStop Color="#30FFFFFF" Offset="0" />
                              <GradientStop Color="#12FFFFFF" Offset="0.4" />
                              <GradientStop Color="#25000000" Offset="1" />
                            </LinearGradientBrush>
                          </Border.Background>
                        </Border>

                        <!-- Kategorie-Schimmer-Overlay -->
                        <Border CornerRadius="11" Opacity="{Binding ShimmerOpacity}">
                          <Border.Background>
                            <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                              <GradientStop Color="{Binding GlowColorHex}" Offset="0" />
                              <GradientStop Color="Transparent" Offset="0.6" />
                            </LinearGradientBrush>
                          </Border.Background>
                        </Border>

                        <Grid RowDefinitions="Auto,*,Auto,Auto" Margin="6">

                          <!-- Oben: Kategorie-Indikator -->
                          <Border Grid.Row="0" CornerRadius="6" Padding="6,3"
                                  HorizontalAlignment="Left" Margin="0,2,0,0">
                            <Border.Background>
                              <SolidColorBrush Color="{Binding BadgeColor}" Opacity="0.2" />
                            </Border.Background>
                            <Ellipse Width="9" Height="9">
                              <Ellipse.Fill>
                                <SolidColorBrush Color="{Binding BadgeColor}" />
                              </Ellipse.Fill>
                            </Ellipse>
                          </Border>

                          <!-- Mitte: Großes Icon -->
                          <Panel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <!-- Gesperrtes Item: Silhouette + Lock -->
                            <Panel IsVisible="{Binding !IsDiscovered}">
                              <skia:SKCanvasView Width="80" Height="80" Opacity="0.35"
                                                 IsVisible="{Binding IsSkiaIcon}"
                                                 Tag="{Binding}" PaintSurface="OnCollectionItemPaint" />
                              <materialIcons:MaterialIcon Width="80" Height="80" Opacity="0.35"
                                                          IsVisible="{Binding !IsSkiaIcon}"
                                                          Kind="{Binding IconName, Converter={x:Static conv:StringToMaterialIconKindConverter.Instance}}"
                                                          Foreground="{Binding BadgeColor, Converter={x:Static coreConv:StringToColorBrushConverter.Instance}}" />
                              <materialIcons:MaterialIcon Kind="LockOutline" Width="36" Height="36"
                                                          Foreground="{DynamicResource TextMutedBrush}"
                                                          Opacity="0.6"
                                                          HorizontalAlignment="Center" VerticalAlignment="Center" />
                            </Panel>
                            <!-- Entdecktes Item: Großes SkiaSharp-Icon -->
                            <skia:SKCanvasView Width="80" Height="80"
                                               IsVisible="{Binding IsDiscovered}"
                                               Tag="{Binding}" PaintSurface="OnCollectionItemPaint" />
                          </Panel>

                          <!-- Name -->
                          <TextBlock Grid.Row="2"
                                     Text="{Binding Name}"
                                     FontSize="12" FontWeight="Bold"
                                     Foreground="{DynamicResource TextPrimaryBrush}"
                                     TextTrimming="CharacterEllipsis"
                                     TextAlignment="Center" MaxLines="1"
                                     HorizontalAlignment="Center" Margin="0,4,0,0"
                                     Opacity="{Binding NameOpacity}" />

                          <!-- Unten: Stat-Anzeige -->
                          <Panel Grid.Row="3" Margin="0,3,0,2">
                            <!-- Entdeckte Items: Stat-Badge -->
                            <Border CornerRadius="5" Padding="5,2"
                                    HorizontalAlignment="Center"
                                    IsVisible="{Binding IsDiscovered}">
                              <Border.Background>
                                <SolidColorBrush Color="{Binding BadgeColor}" Opacity="0.15" />
                              </Border.Background>
                              <TextBlock Text="{Binding StatText}"
                                         FontSize="11" FontWeight="SemiBold">
                                <TextBlock.Foreground>
                                  <SolidColorBrush Color="{Binding BadgeColor}" />
                                </TextBlock.Foreground>
                              </TextBlock>
                            </Border>
                            <!-- Gesperrte Items: Leeres Feld -->
                            <TextBlock IsVisible="{Binding !IsDiscovered}"
                                       Text="???"
                                       FontSize="10" FontWeight="SemiBold"
                                       TextAlignment="Center"
                                       HorizontalAlignment="Center">
                              <TextBlock.Foreground>
                                <SolidColorBrush Color="{Binding BadgeColor}" Opacity="0.4" />
                              </TextBlock.Foreground>
                            </TextBlock>
                          </Panel>
                        </Grid>
                      </Panel>
                    </Border>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>

          <!-- Detail-Panel (Overlay, unten) mit farbigem Rand -->
          <Border IsVisible="{Binding ShowDetail}"
                  Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="0"
                  Margin="20" VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
                  BoxShadow="0 -4 16 0 #40000000"
                  BorderThickness="2"
                  BorderBrush="{Binding DetailBadgeColor, Converter={x:Static coreConv:StringToColorBrushConverter.Instance}}">
            <Grid RowDefinitions="Auto,Auto,Auto" Margin="16">
              <!-- Icon + Name + Schließen in einer Zeile -->
              <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,6">
                <Border Grid.Column="0" Width="40" Height="40" CornerRadius="8"
                        VerticalAlignment="Center">
                  <Border.Background>
                    <SolidColorBrush Color="{Binding DetailBadgeColor}" Opacity="0.15" />
                  </Border.Background>
                  <Panel>
                    <skia:SKCanvasView Width="36" Height="36"
                        x:Name="DetailIconCanvas"
                        IsVisible="{Binding ShowDetail}"
                        Tag="{Binding SelectedEntry}"
                        PaintSurface="OnCollectionDetailPaint" />
                  </Panel>
                </Border>
                <TextBlock Grid.Column="1" Text="{Binding DetailName}"
                           FontSize="18" FontWeight="Bold"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           VerticalAlignment="Center" Margin="10,0,0,0" />
                <Button Grid.Column="2" Classes="Text"
                        Command="{Binding CloseDetailCommand}"
                        Padding="4" VerticalAlignment="Center">
                  <materialIcons:MaterialIcon Kind="Close" Width="20" Height="20"
                                              Foreground="{DynamicResource TextMutedBrush}" />
                </Button>
              </Grid>

              <!-- Lore-Text -->
              <TextBlock Grid.Row="1"
                         Text="{Binding DetailLore}"
                         FontSize="12"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         TextWrapping="Wrap" MaxLines="4" Margin="0,0,0,8" />

              <!-- Stats -->
              <Border Grid.Row="2"
                      Background="{DynamicResource BackgroundBrush}"
                      CornerRadius="8" Padding="10,6"
                      IsVisible="{Binding HasDetailStats}">
                <TextBlock Text="{Binding DetailStats}"
                           FontSize="11" FontWeight="SemiBold"
                           Foreground="{DynamicResource AccentBrush}" />
              </Border>
            </Grid>
          </Border>
        </Panel>
      </Grid>
    </Grid>
  </Panel>

</UserControl>
