<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:views="using:HandwerkerImperium.Views"
             xmlns:miniGames="using:HandwerkerImperium.Views.MiniGames"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:controls="using:MeineApps.UI.Controls"
             xmlns:skia="using:Avalonia.Labs.Controls"
             xmlns:dialogs="using:HandwerkerImperium.Views.Dialogs"
             xmlns:guild="using:HandwerkerImperium.Views.Guild"
             x:Class="HandwerkerImperium.Views.MainView"
             x:DataType="vm:MainViewModel"
             AutomationProperties.AutomationId="Main_Root">

  <UserControl.Styles>
    <!-- Bottom-Sheet Backdrop: Fade-In/Out -->
    <Style Selector="Border.SheetBackdrop">
      <Setter Property="Opacity" Value="0" />
      <Setter Property="IsHitTestVisible" Value="False" />
      <Setter Property="Transitions">
        <Transitions>
          <DoubleTransition Property="Opacity" Duration="0:0:0.2" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.SheetBackdrop.Open">
      <Setter Property="Opacity" Value="1" />
      <Setter Property="IsHitTestVisible" Value="True" />
    </Style>

    <!-- Bottom-Sheet Panel: Slide-Up/Down -->
    <Style Selector="Border.BottomSheet">
      <Setter Property="RenderTransform" Value="translate(0px, 800px)" />
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="CubicEaseOut" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.BottomSheet.Open">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)" />
    </Style>

    <!-- Confirm-Dialog Bottom-Sheet (kleinere Distanz) -->
    <Style Selector="Border.ConfirmSheet">
      <Setter Property="RenderTransform" Value="translate(0px, 400px)" />
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.25" Easing="CubicEaseOut" />
        </Transitions>
      </Setter>
    </Style>
    <Style Selector="Border.ConfirmSheet.Open">
      <Setter Property="RenderTransform" Value="translate(0px, 0px)" />
    </Style>

  </UserControl.Styles>

  <Grid RowDefinitions="*,Auto" AutomationProperties.AutomationId="Main_Grid_Root">

    <!-- ============================================ -->
    <!-- Hintergrund: Animierter SkiaSharp-Background   -->
    <!-- Pro Screen-Typ unterschiedliche Atmosphaere     -->
    <!-- + Vignette-Overlay fuer Tiefe                   -->
    <!-- ============================================ -->
    <skia:SKCanvasView x:Name="BackgroundCanvas"
                        Grid.RowSpan="2"
                        IsHitTestVisible="False"
                        PaintSurface="OnBackgroundPaintSurface"
                        AutomationProperties.AutomationId="Main_Canvas_Background" />

    <!-- ============================================ -->
    <!-- Row 0: Content Area (switches based on tab)  -->
    <!-- ============================================ -->
    <Panel x:Name="ContentPanel" Grid.Row="0" AutomationProperties.AutomationId="Main_Panel_Content">
      <!-- Dashboard Tab (uses MainViewModel directly) -->
      <views:DashboardView IsVisible="{Binding IsDashboardActive}" AutomationProperties.AutomationId="Main_View_Dashboard" />

      <!-- Shop Tab -->
      <views:ShopView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsShopActive}"
                      DataContext="{Binding ShopViewModel}"
                      AutomationProperties.AutomationId="Main_View_Shop" />

      <!-- Statistics Tab -->
      <views:StatisticsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsStatisticsActive}"
                            DataContext="{Binding StatisticsViewModel}"
                            AutomationProperties.AutomationId="Main_View_Statistics" />

      <!-- Achievements Tab -->
      <views:AchievementsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsAchievementsActive}"
                              DataContext="{Binding AchievementsViewModel}"
                              AutomationProperties.AutomationId="Main_View_Achievements" />

      <!-- Settings Tab -->
      <views:SettingsView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsSettingsActive}"
                          DataContext="{Binding SettingsViewModel}"
                          AutomationProperties.AutomationId="Main_View_Settings" />

      <!-- Workshop Detail (overlay when selected) -->
      <views:WorkshopView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWorkshopDetailActive}"
                          DataContext="{Binding WorkshopViewModel}"
                          AutomationProperties.AutomationId="Main_View_WorkshopDetail" />

      <!-- Order Detail (overlay when selected) -->
      <views:OrderView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsOrderDetailActive}"
                       DataContext="{Binding OrderViewModel}"
                       AutomationProperties.AutomationId="Main_View_OrderDetail" />

      <!-- Worker Market (overlay when selected) -->
      <views:WorkerMarketView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWorkerMarketActive}"
                              DataContext="{Binding WorkerMarketViewModel}"
                              AutomationProperties.AutomationId="Main_View_WorkerMarket" />

      <!-- Worker Profile → als Bottom-Sheet (siehe unten) -->

      <!-- Imperium Tab (nutzt IsBuildingsActive, DataContext vom Parent geerbt) -->
      <views:ImperiumView IsVisible="{Binding IsBuildingsActive}"
                          AutomationProperties.AutomationId="Main_View_Imperium" />

      <!-- Missionen Tab (neu) -->
      <views:MissionenView IsVisible="{Binding IsMissionenActive}"
                           AutomationProperties.AutomationId="Main_View_Missionen" />

      <!-- Research (overlay when selected) -->
      <views:ResearchView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsResearchActive}"
                          DataContext="{Binding ResearchViewModel}"
                          AutomationProperties.AutomationId="Main_View_Research" />

      <!-- Neue Feature-Views (Welle 1-8) -->
      <views:ManagerView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsManagerActive}"
                         DataContext="{Binding ManagerViewModel}"
                         AutomationProperties.AutomationId="Main_View_Manager" />
      <views:TournamentView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsTournamentActive}"
                            DataContext="{Binding TournamentViewModel}"
                            AutomationProperties.AutomationId="Main_View_Tournament" />
      <views:SeasonalEventView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsSeasonalEventActive}"
                               DataContext="{Binding SeasonalEventViewModel}"
                               AutomationProperties.AutomationId="Main_View_SeasonalEvent" />
      <views:BattlePassView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsBattlePassActive}"
                            DataContext="{Binding BattlePassViewModel}"
                            AutomationProperties.AutomationId="Main_View_BattlePass" />
      <views:GuildView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsGuildActive}"
                       DataContext="{Binding GuildViewModel}"
                       AutomationProperties.AutomationId="Main_View_Guild" />
      <!-- Gilden-Sub-Seiten (Hub-Navigation) -->
      <guild:GuildResearchView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsGuildResearchActive}"
                               DataContext="{Binding GuildViewModel}"
                               AutomationProperties.AutomationId="Main_View_GuildResearch" />
      <guild:GuildMembersView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsGuildMembersActive}"
                              DataContext="{Binding GuildViewModel}"
                              AutomationProperties.AutomationId="Main_View_GuildMembers" />
      <guild:GuildInviteView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsGuildInviteActive}"
                             DataContext="{Binding GuildViewModel}"
                             AutomationProperties.AutomationId="Main_View_GuildInvite" />
      <views:CraftingView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsCraftingActive}"
                          DataContext="{Binding CraftingViewModel}"
                          AutomationProperties.AutomationId="Main_View_Crafting" />

      <!-- MiniGame Views (overlay when active) -->
      <miniGames:SawingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsSawingGameActive}"
                                DataContext="{Binding SawingGameViewModel}"
                                AutomationProperties.AutomationId="Main_View_SawingGame" />
      <miniGames:PipePuzzleView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsPipePuzzleActive}"
                                DataContext="{Binding PipePuzzleViewModel}"
                                AutomationProperties.AutomationId="Main_View_PipePuzzle" />
      <miniGames:WiringGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsWiringGameActive}"
                                DataContext="{Binding WiringGameViewModel}"
                                AutomationProperties.AutomationId="Main_View_WiringGame" />
      <miniGames:PaintingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsPaintingGameActive}"
                                  DataContext="{Binding PaintingGameViewModel}"
                                  AutomationProperties.AutomationId="Main_View_PaintingGame" />
      <miniGames:RoofTilingGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsRoofTilingGameActive}"
                                    DataContext="{Binding RoofTilingGameViewModel}"
                                    AutomationProperties.AutomationId="Main_View_RoofTilingGame" />
      <miniGames:BlueprintGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsBlueprintGameActive}"
                                   DataContext="{Binding BlueprintGameViewModel}"
                                   AutomationProperties.AutomationId="Main_View_BlueprintGame" />
      <miniGames:DesignPuzzleGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsDesignPuzzleGameActive}"
                                      DataContext="{Binding DesignPuzzleGameViewModel}"
                                      AutomationProperties.AutomationId="Main_View_DesignPuzzleGame" />
      <miniGames:InspectionGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsInspectionGameActive}"
                                    DataContext="{Binding InspectionGameViewModel}"
                                    AutomationProperties.AutomationId="Main_View_InspectionGame" />
      <miniGames:ForgeGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsForgeGameActive}"
                               DataContext="{Binding ForgeGameViewModel}"
                               AutomationProperties.AutomationId="Main_View_ForgeGame" />
      <miniGames:InventGameView IsVisible="{Binding #ContentPanel.((vm:MainViewModel)DataContext).IsInventGameActive}"
                                DataContext="{Binding InventGameViewModel}"
                                AutomationProperties.AutomationId="Main_View_InventGame" />
    </Panel>

    <!-- Ersatz-Spacer wenn Tab-Bar versteckt (Overlay/MiniGame offen) -->
    <!-- Gleiche Hoehe wie Tab-Bar, damit Inhalt ueber der nativen Ad bleibt -->
    <Border Grid.Row="1" Height="68"
            IsVisible="{Binding !IsTabBarVisible}"
            AutomationProperties.AutomationId="Main_Border_TabBarSpacer" />

    <!-- Row 1: Game-Style Tab Bar (SkiaSharp, Holz-Textur mit illustrierten Icons) -->
    <skia:SKCanvasView x:Name="TabBarCanvas"
                        Grid.Row="1"
                        Height="68"
                        Margin="12,0,12,8"
                        IsVisible="{Binding IsTabBarVisible}"
                        PaintSurface="OnTabBarPaintSurface"
                        PointerPressed="OnTabBarPointerPressed"
                        AutomationProperties.AutomationId="Main_Canvas_TabBar" />

    <!-- Screen-Transition Overlay (SkiaSharp, über Content, unter Dialogen) -->
    <skia:SKCanvasView x:Name="TransitionCanvas"
                        Grid.RowSpan="2"
                        IsHitTestVisible="False"
                        PaintSurface="OnTransitionPaintSurface"
                        AutomationProperties.AutomationId="Main_Canvas_Transition" />

    <!-- ============================================ -->
    <!-- Dialog Overlays                              -->
    <!-- ============================================ -->

    <!-- Offline Earnings Dialog (extrahiert in UserControl) -->
    <dialogs:OfflineEarningsDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Level-Up: Kein Dialog mehr, nur noch dezente Pulse-Animation
         (IsLevelUpPulsing wird im Dashboard-Header genutzt) -->

    <!-- Daily Reward Dialog (extrahiert in UserControl) -->
    <dialogs:DailyRewardDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Welcome Back Offer Dialog (extrahiert in UserControl) -->
    <dialogs:WelcomeBackOfferDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Lucky Spin Bottom-Sheet Overlay -->
    <Border Grid.RowSpan="2"
            Classes="SheetBackdrop"
            Classes.Open="{Binding IsLuckySpinVisible}"
            IsVisible="{Binding IsLuckySpinVisible}"
            Background="#AA000000"
            IsHitTestVisible="{Binding IsLuckySpinVisible}"
            AutomationProperties.AutomationId="Main_Overlay_LuckySpin">
      <Border Classes="BottomSheet"
              Classes.Open="{Binding IsLuckySpinVisible}"
              VerticalAlignment="Bottom"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="24,24,0,0"
              Padding="20,16,20,24"
              BoxShadow="0 -4 20 0 #40FFD700"
              AutomationProperties.AutomationId="Main_Border_LuckySpinSheet">
        <views:LuckySpinView DataContext="{Binding LuckySpinViewModel}"
                              AutomationProperties.AutomationId="Main_View_LuckySpin" />
      </Border>
    </Border>

    <!-- Achievement Unlocked Dialog (extrahiert in UserControl) -->
    <dialogs:AchievementDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Tutorial Overlay (extrahiert in UserControl) -->
    <dialogs:TutorialDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Story Dialog mit Meister Hans (extrahiert in UserControl) -->
    <dialogs:StoryDialog x:Name="StoryDialogControl" Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Alert Dialog (extrahiert in UserControl) -->
    <dialogs:AlertDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Confirm Dialog (extrahiert in UserControl) -->
    <dialogs:ConfirmDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Worker Profile Bottom-Sheet (extrahiert in UserControl) -->
    <dialogs:WorkerProfileDialog Grid.RowSpan="2" DataContext="{Binding}" />

    <!-- Worker-Undo Snackbar (5s Rückgängig nach Entlassung) -->
    <Border Grid.RowSpan="2"
            IsVisible="{Binding WorkerProfileViewModel.ShowUndoFireWorker}"
            VerticalAlignment="Bottom" HorizontalAlignment="Stretch"
            Margin="16,0,16,80"
            Background="#E6333333" CornerRadius="12" Padding="12,10"
            ZIndex="90"
            AutomationProperties.AutomationId="Main_Border_UndoFireWorker">
      <Grid ColumnDefinitions="*,Auto">
        <TextBlock Text="{Binding WorkerProfileViewModel.UndoFireWorkerText}"
                   Foreground="White" FontSize="13"
                   VerticalAlignment="Center"
                   AutomationProperties.AutomationId="Main_Txt_UndoFireWorker" />
        <Button Grid.Column="1"
                Command="{Binding WorkerProfileViewModel.UndoFireWorkerCommand}"
                Background="Transparent" BorderThickness="0"
                Padding="8,4" Cursor="Hand"
                AutomationProperties.AutomationId="Main_Btn_UndoFireWorker">
          <TextBlock Text="{loc:Translate Undo}"
                     Foreground="{StaticResource CraftGoldBrush}"
                     FontSize="14" FontWeight="Bold" />
        </Button>
      </Grid>
    </Border>

    <!-- Confetti-Overlay (Level-Up, Achievement-Unlock) -->
    <controls:SkiaCelebrationOverlay x:Name="CelebrationCanvas"
                                     Grid.RowSpan="2"
                                     ZIndex="100"
                                     IsHitTestVisible="False"
                                     AutomationProperties.AutomationId="Main_Img_CelebrationOverlay" />

    <!-- Full-Screen Reward-Zeremonie (Feuerwerk + Confetti + Text) -->
    <skia:SKCanvasView x:Name="CeremonyCanvas"
                       Grid.RowSpan="2"
                       ZIndex="110"
                       IsVisible="False"
                       PaintSurface="OnCeremonyPaintSurface"
                       PointerPressed="OnCeremonyTapped"
                       AutomationProperties.AutomationId="Main_Canvas_Ceremony" />

    <!-- Animierter Loading-Screen (Zahnräder + Fortschritt + Tipps) -->
    <skia:SKCanvasView x:Name="LoadingCanvas"
                       Grid.RowSpan="2"
                       ZIndex="200"
                       IsVisible="{Binding IsLoading}"
                       PaintSurface="OnLoadingPaintSurface"
                       AutomationProperties.AutomationId="Main_Canvas_Loading" />

  </Grid>

</UserControl>
