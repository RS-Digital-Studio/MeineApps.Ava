<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             x:Class="HandwerkerImperium.Views.MiniGames.RoofTilingGameView"
             x:DataType="vm:RoofTilingGameViewModel">

  <Grid RowDefinitions="Auto,*,Auto" Margin="20">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Classes="CardElevated"
            Padding="16,12">
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Abbrechen-Button -->
        <Button Classes="Text"
                Command="{Binding CancelCommand}">
          <mi:MaterialIcon Kind="Close" Width="24" Height="24" />
        </Button>

        <!-- Titel -->
        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal"
                      HorizontalAlignment="Center"
                      Spacing="6">
            <mi:MaterialIcon Kind="HomeRoof" Width="22" Height="22" />
            <TextBlock Text="{loc:Translate RoofTilingGame}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
          </StackPanel>
          <TextBlock Text="{Binding DifficultyStars}"
                     HorizontalAlignment="Center"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}" />
        </StackPanel>

        <!-- Timer -->
        <Border Grid.Column="2"
                Background="{DynamicResource SurfaceBrush}"
                CornerRadius="8"
                Padding="12,6">
          <StackPanel Orientation="Horizontal" Spacing="4">
            <mi:MaterialIcon Kind="Clock" Width="16" Height="16" />
            <TextBlock Text="{Binding TimeRemaining, StringFormat='{}{0}s'}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}" />
          </StackPanel>
        </Border>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- SPIELBEREICH                                                      -->
    <!-- ================================================================= -->
    <Grid Grid.Row="1" VerticalAlignment="Center" Margin="0,20">
      <StackPanel Spacing="20">

        <!-- Anweisungen (vor Spielstart) -->
        <TextBlock Text="{loc:Translate PlaceMatchingTiles}"
                   FontSize="12"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   HorizontalAlignment="Center"
                   IsVisible="{Binding !IsPlaying}" />

        <!-- Anweisungen (während Spielstart) -->
        <TextBlock Text="{loc:Translate TapTileToPlace}"
                   FontSize="12"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   HorizontalAlignment="Center"
                   IsVisible="{Binding IsPlaying}" />

        <!-- Fortschritt + Fehler -->
        <Grid ColumnDefinitions="*,Auto,*"
              IsVisible="{Binding IsPlaying}">

          <!-- Fortschritt links -->
          <StackPanel Orientation="Horizontal" Spacing="4"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
            <mi:MaterialIcon Kind="CheckCircle" Width="16" Height="16"
                             Foreground="{DynamicResource SuccessBrush}" />
            <TextBlock FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}">
              <Run Text="{Binding PlacedCount}" />
              <Run Text="/" />
              <Run Text="{Binding TotalToPlace}" />
            </TextBlock>
          </StackPanel>

          <!-- Trennlinie -->
          <Border Grid.Column="1" Width="1" Height="16"
                  Background="{DynamicResource TextSecondaryBrush}"
                  Opacity="0.3" />

          <!-- Fehler rechts -->
          <StackPanel Grid.Column="2"
                      Orientation="Horizontal" Spacing="4"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
            <mi:MaterialIcon Kind="Close" Width="16" Height="16"
                             Foreground="{DynamicResource ErrorBrush}" />
            <TextBlock FontSize="12"
                       Foreground="{DynamicResource TextSecondaryBrush}">
              <Run Text="{loc:Translate MistakesLabel}" />
              <Run Text=" " />
              <Run Text="{Binding MistakeCount}" />
            </TextBlock>
          </StackPanel>
        </Grid>

        <!-- Farbauswahl-Leiste -->
        <Border Classes="Card StatsCard" Padding="12"
                HorizontalAlignment="Center"
                IsVisible="{Binding !IsResultShown}">
          <StackPanel Spacing="8">
            <TextBlock Text="{loc:Translate SelectColor}"
                       FontSize="11"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       HorizontalAlignment="Center" />
            <ItemsControl ItemsSource="{Binding AvailableColors}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Orientation="Horizontal" Spacing="8" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="x:String">
                  <Button Classes="Text" Padding="0"
                          Command="{Binding $parent[ItemsControl].((vm:RoofTilingGameViewModel)DataContext).SelectColorCommand}"
                          CommandParameter="{Binding .}">
                    <Border Width="42" Height="42"
                            CornerRadius="8"
                            Background="{Binding .}"
                            BorderThickness="3"
                            Cursor="Hand">
                      <Border.BorderBrush>
                        <SolidColorBrush Color="White" Opacity="0.3" />
                      </Border.BorderBrush>
                    </Border>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>

        <!-- Dach-Gitter -->
        <Border Classes="Card StatsCard" Padding="16"
                HorizontalAlignment="Center">
          <ItemsControl ItemsSource="{Binding Tiles}"
                        Width="{Binding TileGridWidth}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal" />
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:RoofTile">
                <Button Classes="Text" Padding="0" Margin="2"
                        Command="{Binding $parent[ItemsControl].((vm:RoofTilingGameViewModel)DataContext).PlaceTileCommand}"
                        CommandParameter="{Binding .}">
                  <Border Width="50" Height="50"
                          CornerRadius="4"
                          BorderThickness="2"
                          BorderBrush="{Binding BorderColor}"
                          Background="{Binding DisplayColor}">
                    <Panel>
                      <!-- Hinweis-Indikator (Schloss-Icon für vorplatzierte Ziegel) -->
                      <mi:MaterialIcon Kind="Lock" Width="16" Height="16"
                                       Foreground="#60FFFFFF"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding IsHint}" />

                      <!-- Korrekt platziert (Häkchen) -->
                      <mi:MaterialIcon Kind="Check" Width="20" Height="20"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding IsPlaced}">
                        <mi:MaterialIcon.IsVisible>
                          <MultiBinding Converter="{x:Static BoolConverters.And}">
                            <Binding Path="IsPlaced" />
                            <Binding Path="!IsHint" />
                          </MultiBinding>
                        </mi:MaterialIcon.IsVisible>
                      </mi:MaterialIcon>

                      <!-- Fehler-Markierung -->
                      <mi:MaterialIcon Kind="Close" Width="20" Height="20"
                                       Foreground="{DynamicResource ErrorBrush}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding HasError}" />
                    </Panel>
                  </Border>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </Border>

        <!-- Gewählte Farbe Anzeige -->
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Spacing="8"
                    IsVisible="{Binding IsPlaying}">
          <TextBlock Text="{loc:Translate SelectedColorLabel}"
                     FontSize="12"
                     Foreground="{DynamicResource TextSecondaryBrush}"
                     VerticalAlignment="Center" />
          <Border Width="30" Height="30"
                  CornerRadius="6"
                  Background="{Binding SelectedColor}" />
        </StackPanel>

        <!-- Ergebnis-Anzeige -->
        <Border Classes="Card StatsCard"
                IsVisible="{Binding IsResultShown}"
                Padding="24">
          <StackPanel Spacing="16" HorizontalAlignment="Center">
            <TextBlock Text="{Binding ResultEmoji}"
                       FontSize="48"
                       HorizontalAlignment="Center" />

            <!-- Sterne-Bewertung (staggered) -->
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star1Opacity}" />
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star2Opacity}" />
              <mi:MaterialIcon Kind="Star" Width="32" Height="32"
                               Foreground="#FFD700"
                               Opacity="{Binding Star3Opacity}" />
            </StackPanel>

            <TextBlock Text="{Binding ResultText}"
                       FontSize="24" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       HorizontalAlignment="Center" />

            <!-- Belohnungen -->
            <StackPanel Orientation="Horizontal" Spacing="20"
                        HorizontalAlignment="Center">
              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="CashMultiple" Width="20" Height="20"
                                 Foreground="{DynamicResource SuccessBrush}" />
                <TextBlock Text="{Binding RewardAmount, StringFormat='+{0:N0} €'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="{DynamicResource SuccessBrush}"
                           VerticalAlignment="Center" />
              </StackPanel>

              <StackPanel Orientation="Horizontal" Spacing="4">
                <mi:MaterialIcon Kind="Star" Width="20" Height="20"
                                 Foreground="Gold" />
                <TextBlock Text="{Binding XpAmount, StringFormat='+{0} XP'}"
                           FontSize="14" FontWeight="Bold"
                           Foreground="Gold"
                           VerticalAlignment="Center" />
              </StackPanel>
            </StackPanel>
          </StackPanel>
        </Border>

      </StackPanel>
    </Grid>

    <!-- Countdown Overlay (3, 2, 1, Los!) -->
    <Border Grid.RowSpan="3" Background="#CC000000"
            IsVisible="{Binding IsCountdownActive}">
      <TextBlock Text="{Binding CountdownText}"
                 FontSize="72" FontWeight="Bold"
                 Foreground="#FFD700"
                 HorizontalAlignment="Center" VerticalAlignment="Center" />
    </Border>

    <!-- ================================================================= -->
    <!-- ACTION BUTTONS                                                    -->
    <!-- ================================================================= -->
    <StackPanel Grid.Row="2" Spacing="16">

      <!-- Start Button (versteckt während Spiel und nach Ergebnis) -->
      <Panel IsVisible="{Binding !IsResultShown}">
        <Button Content="{loc:Translate StartRoofTiling}"
                Classes="Primary"
                Command="{Binding StartGameCommand}"
                IsVisible="{Binding !IsPlaying}"
                HorizontalAlignment="Center"
                MinWidth="220" />
      </Panel>

      <!-- Continue Buttons -->
      <Grid ColumnDefinitions="*,*"
            ColumnSpacing="12"
            IsVisible="{Binding IsResultShown}">

        <Button Content="{loc:Translate WatchAdForDouble}"
                Classes="Secondary"
                IsEnabled="{Binding CanWatchAd}"
                Command="{Binding WatchAdCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />

        <Button Grid.Column="1"
                Content="{loc:Translate Continue}"
                Classes="Primary"
                Command="{Binding ContinueCommand}"
                HorizontalAlignment="Stretch"
                HorizontalContentAlignment="Center" />
      </Grid>

    </StackPanel>

  </Grid>

</UserControl>
