<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:HandwerkerImperium.ViewModels"
             xmlns:models="using:HandwerkerImperium.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:loc="using:MeineApps.Core.Ava.Localization"
             xmlns:controls="using:HandwerkerImperium.Controls"
             x:Class="HandwerkerImperium.Views.WorkerMarketView"
             x:DataType="vm:WorkerMarketViewModel">

  <Grid RowDefinitions="Auto,*" AutomationProperties.AutomationId="WorkerMarket_Grid_Root">

    <!-- ================================================================= -->
    <!-- HEADER                                                            -->
    <!-- ================================================================= -->
    <Border Grid.Row="0"
            Padding="16,12"
            CornerRadius="0,0,12,12"
            AutomationProperties.AutomationId="WorkerMarket_Border_Header">
      <Border.Background>
        <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
          <GradientStop Color="#92400E" Offset="0" />
          <GradientStop Color="#451A03" Offset="1" />
        </LinearGradientBrush>
      </Border.Background>
      <Grid ColumnDefinitions="Auto,*,Auto">
        <!-- Back Button -->
        <Button Classes="Text"
                Command="{Binding GoBackCommand}"
                AutomationProperties.AutomationId="WorkerMarket_Btn_Back">
          <mi:MaterialIcon Kind="ArrowLeft" Width="24" Height="24"
                           Foreground="{StaticResource CraftPrimaryLightBrush}"
                           AutomationProperties.AutomationId="WorkerMarket_Icon_Back" />
        </Button>

        <!-- Title (centered) -->
        <StackPanel Grid.Column="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="8"
                    AutomationProperties.AutomationId="WorkerMarket_Panel_Title">
          <mi:MaterialIcon Kind="AccountGroup" Width="28" Height="28"
                           Foreground="{StaticResource CraftPrimaryLightBrush}"
                           AutomationProperties.AutomationId="WorkerMarket_Icon_Title" />
          <TextBlock Text="{Binding Title}"
                     FontSize="20" FontWeight="Bold"
                     Foreground="{StaticResource CraftPrimaryLightBrush}"
                     AutomationProperties.AutomationId="WorkerMarket_Txt_Title" />
        </StackPanel>

        <!-- Balance Badges -->
        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8"
                    VerticalAlignment="Center"
                    AutomationProperties.AutomationId="WorkerMarket_Panel_Balances">
          <!-- Goldschrauben-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4"
                  AutomationProperties.AutomationId="WorkerMarket_Border_ScrewsBadge">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <mi:MaterialIcon Kind="ScrewFlatTop" Width="16" Height="16" Foreground="{StaticResource CraftGoldBrush}"
                               AutomationProperties.AutomationId="WorkerMarket_Icon_Screws" />
              <TextBlock Text="{Binding GoldenScrewsDisplay}" FontSize="14" FontWeight="Bold"
                         Foreground="{StaticResource CraftGoldBrush}"
                         AutomationProperties.AutomationId="WorkerMarket_Txt_Screws" />
            </StackPanel>
          </Border>
          <!-- Euro-Badge -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="12" Padding="8,4"
                  AutomationProperties.AutomationId="WorkerMarket_Border_BalanceBadge">
            <TextBlock Text="{Binding CurrentBalance}"
                       FontSize="14" FontWeight="Bold"
                       Foreground="{DynamicResource SuccessBrush}"
                       AutomationProperties.AutomationId="WorkerMarket_Txt_Balance" />
          </Border>
        </StackPanel>
      </Grid>
    </Border>

    <!-- ================================================================= -->
    <!-- CONTENT                                                           -->
    <!-- ================================================================= -->
    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto"
                  IsVisible="{Binding !ShowWorkshopSelection}">
      <StackPanel Spacing="16" Margin="16">

        <!-- ROTATION TIMER -->
        <Border Classes="CardElevated" Padding="16"
                AutomationProperties.AutomationId="WorkerMarket_Border_RotationTimer">
          <Grid ColumnDefinitions="*,Auto">
            <StackPanel Spacing="4">
              <TextBlock Text="{Binding NextRotationLabel}"
                         FontSize="14"
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         AutomationProperties.AutomationId="WorkerMarket_Txt_RotationLabel" />
              <TextBlock Text="{Binding TimeUntilRotation}"
                         FontSize="24" FontWeight="Bold"
                         Foreground="{StaticResource CraftPrimaryLightBrush}"
                         AutomationProperties.AutomationId="WorkerMarket_Txt_Timer" />
            </StackPanel>

            <!-- Refresh Button: Gratis (1x pro Rotation) oder Video-Ad -->
            <Button Grid.Column="1"
                    Classes="Secondary"
                    Command="{Binding RefreshWithAdCommand}"
                    VerticalAlignment="Center"
                    Padding="12,8"
                    AutomationProperties.AutomationId="WorkerMarket_Btn_Refresh">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <!-- Gratis: Refresh-Icon grün -->
                <mi:MaterialIcon Kind="Refresh" Width="18" Height="18"
                                 Foreground="{DynamicResource SuccessBrush}"
                                 IsVisible="{Binding HasFreeRefresh}"
                                 AutomationProperties.AutomationId="WorkerMarket_Icon_FreeRefresh" />
                <!-- Kostenpflichtig: Video-Icon -->
                <mi:MaterialIcon Kind="Video" Width="18" Height="18"
                                 IsVisible="{Binding !HasFreeRefresh}"
                                 AutomationProperties.AutomationId="WorkerMarket_Icon_AdRefresh" />
                <TextBlock Text="{Binding RefreshButtonText}" FontSize="13"
                           AutomationProperties.AutomationId="WorkerMarket_Txt_RefreshButton" />
              </StackPanel>
            </Button>
          </Grid>
        </Border>

        <!-- KEINE FREIEN PLAETZE INFO (Warnung, blockiert nicht den Markt) -->
        <Border Classes="CardElevated" Padding="16,12"
                IsVisible="{Binding !HasAvailableSlots}"
                AutomationProperties.AutomationId="WorkerMarket_Border_NoSlotsWarning">
          <StackPanel Spacing="10">
            <!-- Icon zentriert ueber dem Text -->
            <mi:MaterialIcon Kind="AlertCircleOutline" Width="24" Height="24"
                             Foreground="{DynamicResource WarningBrush}"
                             HorizontalAlignment="Center"
                             AutomationProperties.AutomationId="WorkerMarket_Icon_NoSlotsAlert" />
            <TextBlock Text="{Binding NoSlotsMessage}"
                       FontSize="13"
                       Foreground="{DynamicResource WarningBrush}"
                       TextWrapping="Wrap"
                       TextAlignment="Center"
                       AutomationProperties.AutomationId="WorkerMarket_Txt_NoSlotsMessage" />

            <!-- Extra-Slot per Video-Ad Button -->
            <Button Classes="Secondary"
                    Command="{Binding WatchAdForWorkerSlotCommand}"
                    IsVisible="{Binding ShowExtraSlotButton}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12,8"
                    AutomationProperties.AutomationId="WorkerMarket_Btn_WatchAdExtraSlot">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <mi:MaterialIcon Kind="Video" Width="18" Height="18"
                                 Foreground="{StaticResource CraftPrimaryLightBrush}"
                                 AutomationProperties.AutomationId="WorkerMarket_Icon_AdExtraSlot" />
                <TextBlock Text="{loc:Translate WatchAdForWorkerSlot}" FontSize="13"
                           AutomationProperties.AutomationId="WorkerMarket_Txt_AdExtraSlot" />
              </StackPanel>
            </Button>
          </StackPanel>
        </Border>

        <!-- Empty State: Keine Arbeiter verfügbar -->
        <StackPanel IsVisible="{Binding HasNoAvailableWorkers}" Spacing="8"
                    HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,24"
                    AutomationProperties.AutomationId="WorkerMarket_Panel_EmptyState">
          <mi:MaterialIcon Kind="AccountSearch" Width="48" Height="48"
                           Foreground="{DynamicResource TextMutedBrush}" HorizontalAlignment="Center"
                           AutomationProperties.AutomationId="WorkerMarket_Icon_EmptyState" />
          <TextBlock Text="{loc:Translate NoWorkersAvailable}" FontSize="14"
                     Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"
                     AutomationProperties.AutomationId="WorkerMarket_Txt_EmptyState" />
        </StackPanel>

        <!-- WORKER CARDS (immer sichtbar, Hire-Button disabled wenn keine Plaetze) -->
        <ItemsControl ItemsSource="{Binding AvailableWorkers}">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:Worker">
              <Border Classes="Card" Margin="0,0,0,12" Padding="16"
                      AutomationProperties.AutomationId="WorkerMarket_Border_WorkerCard">
                <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                      ColumnDefinitions="Auto,*,Auto"
                      RowSpacing="8">

                  <!-- Row 0, Col 0: Avatar -->
                  <controls:WorkerAvatarControl
                      IdSeed="{Binding Id}"
                      Tier="{Binding Tier}"
                      Mood="70"
                      AvatarSize="56"
                      IsFemale="{Binding IsFemale}"
                      VerticalAlignment="Center"
                      Margin="0,0,10,0" />

                  <!-- Row 0, Col 1: Name + Tier Badge -->
                  <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Name}"
                               FontSize="16" FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               AutomationProperties.AutomationId="WorkerMarket_Txt_WorkerName" />
                    <Border Background="{StaticResource CraftPrimaryBrush}"
                            CornerRadius="4"
                            Padding="8,2"
                            AutomationProperties.AutomationId="WorkerMarket_Border_TierBadge">
                      <TextBlock Text="{Binding Tier}"
                                 FontSize="12" FontWeight="Bold"
                                 Foreground="White"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_Tier" />
                    </Border>
                  </StackPanel>

                  <!-- Row 0, Col 2: Wage -->
                  <TextBlock Grid.Column="2"
                             Text="{Binding WagePerHour, StringFormat='{}{0:N0} €/h'}"
                             FontSize="13" FontWeight="SemiBold"
                             Foreground="{DynamicResource WarningBrush}"
                             VerticalAlignment="Center"
                             AutomationProperties.AutomationId="WorkerMarket_Txt_Wage" />

                  <!-- Row 1: Personality + Talent Stars + Specialization -->
                  <StackPanel Grid.Row="1" Grid.ColumnSpan="3"
                              Orientation="Horizontal" Spacing="12">
                    <!-- Personality -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                      <mi:MaterialIcon Kind="{Binding PersonalityIcon, Converter={StaticResource IconKindConverter}}"
                                       Width="14" Height="14" VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       AutomationProperties.AutomationId="WorkerMarket_Icon_PersonalityIcon" />
                      <TextBlock Text="{Binding PersonalityDisplay}"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 VerticalAlignment="Center"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_Personality" />
                    </StackPanel>

                    <!-- Talent Stars -->
                    <StackPanel Orientation="Horizontal" Spacing="2"
                                AutomationProperties.AutomationId="WorkerMarket_Panel_Talent">
                      <mi:MaterialIcon Kind="Star" Width="14" Height="14"
                                       Foreground="{StaticResource CraftGoldBrush}"
                                       AutomationProperties.AutomationId="WorkerMarket_Icon_TalentStar" />
                      <TextBlock Text="{Binding Talent}"
                                 FontSize="12" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalAlignment="Center"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_Talent" />
                    </StackPanel>
                  </StackPanel>

                  <!-- Row 2: Specialization + Efficiency + Mehrwert -->
                  <StackPanel Grid.Row="2" Grid.ColumnSpan="3"
                              Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="{Binding SpecializationDisplay}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               IsVisible="{Binding SpecializationDisplay, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               AutomationProperties.AutomationId="WorkerMarket_Txt_Specialization" />
                    <TextBlock FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               AutomationProperties.AutomationId="WorkerMarket_Txt_Efficiency">
                      <Run Text="{loc:Translate EfficiencyShort}" />
                      <Run Text="{Binding Efficiency, StringFormat='{}{0:P0}'}" FontWeight="SemiBold" />
                    </TextBlock>
                    <TextBlock Text="{Binding IncomeContributionDisplay}"
                               FontSize="12" FontWeight="SemiBold"
                               Foreground="{DynamicResource SuccessBrush}"
                               IsVisible="{Binding IncomeContribution}"
                               AutomationProperties.AutomationId="WorkerMarket_Txt_IncomeContribution" />
                  </StackPanel>

                  <!-- Row 3: Hire Button (disabled wenn keine Plaetze frei) -->
                  <Button Grid.Row="3" Grid.ColumnSpan="3"
                          Classes="Primary"
                          HorizontalAlignment="Stretch"
                          Padding="12,8"
                          IsEnabled="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).HasAvailableSlots}"
                          Command="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).HireWorkerCommand}"
                          CommandParameter="{Binding .}"
                          AutomationProperties.AutomationId="WorkerMarket_Btn_Hire">
                    <StackPanel Orientation="Horizontal"
                                Spacing="6"
                                HorizontalAlignment="Center">
                      <mi:MaterialIcon Kind="AccountPlus" Width="16" Height="16"
                                       AutomationProperties.AutomationId="WorkerMarket_Icon_Hire" />
                      <TextBlock Text="{Binding HiringCost, StringFormat='{}{0:N0} €'}"
                                 FontSize="13" FontWeight="SemiBold"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_HiringCost" />
                      <!-- Goldschrauben-Kosten (nur Tier A+S) -->
                      <StackPanel Orientation="Horizontal" Spacing="2"
                                  IsVisible="{Binding HiringScrewCost}"
                                  AutomationProperties.AutomationId="WorkerMarket_Panel_ScrewCost">
                        <TextBlock Text="+" FontSize="13" FontWeight="SemiBold" />
                        <mi:MaterialIcon Kind="ScrewFlatTop" Width="14" Height="14"
                                         Foreground="{StaticResource CraftGoldBrush}"
                                         AutomationProperties.AutomationId="WorkerMarket_Icon_ScrewCost" />
                        <TextBlock Text="{Binding HiringScrewCost}"
                                   FontSize="13" FontWeight="SemiBold"
                                   Foreground="{StaticResource CraftGoldBrush}"
                                   AutomationProperties.AutomationId="WorkerMarket_Txt_ScrewCost" />
                      </StackPanel>
                    </StackPanel>
                  </Button>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Bottom Spacer -->
        <Border Height="80" />

      </StackPanel>
    </ScrollViewer>

    <!-- ================================================================= -->
    <!-- WORKSHOP-AUSWAHL OVERLAY (Bug 3: Spieler waehlt Workshop)        -->
    <!-- ================================================================= -->
    <Border Grid.RowSpan="2"
            IsVisible="{Binding ShowWorkshopSelection}"
            Background="{StaticResource DialogOverlayBrush}"
            AutomationProperties.AutomationId="WorkerMarket_Border_OverlayBackdrop">
      <Border Background="{DynamicResource BackgroundBrush}"
              BorderBrush="{StaticResource CraftPrimaryBrush}"
              BorderThickness="2"
              MaxWidth="400"
              Margin="24"
              Padding="20"
              CornerRadius="16"
              VerticalAlignment="Center"
              HorizontalAlignment="Center"
              BoxShadow="0 8 24 0 #40000000"
              AutomationProperties.AutomationId="WorkerMarket_Border_WorkshopSelectionDialog">
        <StackPanel Spacing="16">

          <!-- Overlay-Titel -->
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center"
                      AutomationProperties.AutomationId="WorkerMarket_Panel_OverlayTitle">
            <mi:MaterialIcon Kind="Factory" Width="24" Height="24"
                             Foreground="{StaticResource CraftPrimaryLightBrush}"
                             AutomationProperties.AutomationId="WorkerMarket_Icon_OverlayFactory" />
            <TextBlock Text="{Binding SelectWorkshopTitle}"
                       FontSize="18" FontWeight="Bold"
                       Foreground="{DynamicResource TextPrimaryBrush}"
                       AutomationProperties.AutomationId="WorkerMarket_Txt_OverlayTitle" />
          </StackPanel>

          <!-- Pendender Worker Info -->
          <Border Background="{DynamicResource SurfaceBrush}"
                  CornerRadius="8" Padding="12,8"
                  AutomationProperties.AutomationId="WorkerMarket_Border_PendingWorker">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
              <mi:MaterialIcon Kind="AccountPlus" Width="18" Height="18"
                               Foreground="{StaticResource CraftPrimaryLightBrush}"
                               AutomationProperties.AutomationId="WorkerMarket_Icon_PendingWorker" />
              <TextBlock Text="{Binding PendingWorker.Name}"
                         FontSize="14" FontWeight="SemiBold"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         AutomationProperties.AutomationId="WorkerMarket_Txt_PendingWorkerName" />
              <Border Background="{StaticResource CraftPrimaryBrush}"
                      CornerRadius="4" Padding="6,2"
                      AutomationProperties.AutomationId="WorkerMarket_Border_PendingTierBadge">
                <TextBlock Text="{Binding PendingWorker.Tier}"
                           FontSize="11" FontWeight="Bold" Foreground="White"
                           AutomationProperties.AutomationId="WorkerMarket_Txt_PendingTier" />
              </Border>
            </StackPanel>
          </Border>

          <!-- Workshop-Liste -->
          <ItemsControl ItemsSource="{Binding WorkshopSelections}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:WorkshopSelectionItem">
                <Button Classes="Outlined"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch"
                        Margin="0,0,0,8"
                        Padding="16,14"
                        MinHeight="56"
                        Command="{Binding $parent[ItemsControl].((vm:WorkerMarketViewModel)DataContext).ConfirmWorkshopSelectionCommand}"
                        CommandParameter="{Binding .}"
                        AutomationProperties.AutomationId="WorkerMarket_Btn_SelectWorkshop">
                  <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Spacing="4">
                      <TextBlock Text="{Binding Name}"
                                 FontSize="15" FontWeight="SemiBold"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_WorkshopName" />
                      <TextBlock Text="{Binding WorkerInfo}"
                                 FontSize="13"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 AutomationProperties.AutomationId="WorkerMarket_Txt_WorkshopWorkerInfo" />
                    </StackPanel>
                    <mi:MaterialIcon Grid.Column="1" Kind="ChevronRight"
                                     Width="24" Height="24"
                                     Foreground="{StaticResource CraftPrimaryLightBrush}"
                                     VerticalAlignment="Center"
                                     AutomationProperties.AutomationId="WorkerMarket_Icon_WorkshopChevron" />
                  </Grid>
                </Button>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- Abbrechen Button -->
          <Button Classes="Secondary"
                  HorizontalAlignment="Stretch"
                  HorizontalContentAlignment="Center"
                  Command="{Binding CancelWorkshopSelectionCommand}"
                  Padding="12,10"
                  AutomationProperties.AutomationId="WorkerMarket_Btn_CancelSelection">
            <TextBlock Text="{Binding CancelText}"
                       FontSize="14"
                       AutomationProperties.AutomationId="WorkerMarket_Txt_Cancel" />
          </Button>

        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
