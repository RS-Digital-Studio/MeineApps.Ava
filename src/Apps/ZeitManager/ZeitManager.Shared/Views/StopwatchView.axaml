<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ZeitManager.ViewModels"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:models="using:ZeitManager.Models"
             x:Class="ZeitManager.Views.StopwatchView"
             x:DataType="vm:StopwatchViewModel">

  <UserControl.Styles>
    <!-- Glow-Effekt für aktiven Stoppuhr-Ring -->
    <Style Selector="Border.StopwatchGlow">
      <Style.Animations>
        <Animation Duration="0:0:1.5" IterationCount="INFINITE">
          <KeyFrame Cue="0%"><Setter Property="Opacity" Value="0.4" /></KeyFrame>
          <KeyFrame Cue="50%"><Setter Property="Opacity" Value="0.8" /></KeyFrame>
          <KeyFrame Cue="100%"><Setter Property="Opacity" Value="0.4" /></KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,Auto,*">

    <!-- Time Display mit Ring -->
    <Border Grid.Row="0" Margin="16,16,16,8" HorizontalAlignment="Center">
      <Grid Width="280" Height="280">
        <!-- Äußerer Ring (Track) -->
        <Border CornerRadius="140" BorderThickness="4" Width="280" Height="280"
                BorderBrush="{DynamicResource BorderSubtleBrush}" />

        <!-- Aktiver Ring (Cyan, sichtbar wenn laufend) -->
        <Border CornerRadius="140" BorderThickness="4" Width="280" Height="280"
                BorderBrush="{DynamicResource StopwatchAccentBrush}"
                IsVisible="{Binding IsRunning}" />

        <!-- Glow-Ring (animierter äußerer Schein) -->
        <Border Classes="StopwatchGlow"
                CornerRadius="148" BorderThickness="3" Width="296" Height="296"
                BorderBrush="{DynamicResource StopwatchAccentBrush}"
                IsVisible="{Binding IsRunning}"
                HorizontalAlignment="Center" VerticalAlignment="Center" />

        <!-- Zeitanzeige -->
        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="0">
          <!-- Hauptzeit (min:sec) -->
          <TextBlock Text="{Binding ElapsedTimeFormatted}"
                     FontSize="48" FontWeight="Light"
                     Foreground="{DynamicResource TextPrimaryBrush}"
                     HorizontalAlignment="Center" />
        </StackPanel>
      </Grid>
    </Border>

    <!-- Steuerungs-Buttons -->
    <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="16"
                HorizontalAlignment="Center" Margin="16,8">

      <!-- Runde (bei laufend) -->
      <Button Classes="Outlined" Width="56" Height="56" CornerRadius="28" Padding="0"
              IsVisible="{Binding IsRunning}"
              Command="{Binding LapCommand}">
        <mi:MaterialIcon Kind="FlagCheckered" Width="24" Height="24"
                         Foreground="{DynamicResource StopwatchAccentBrush}" />
      </Button>

      <!-- Reset (bei gestoppt) -->
      <Button Classes="Outlined" Width="56" Height="56" CornerRadius="28" Padding="0"
              IsVisible="{Binding !IsRunning}"
              Command="{Binding ResetCommand}">
        <mi:MaterialIcon Kind="Refresh" Width="24" Height="24" />
      </Button>

      <!-- Start/Stop Button -->
      <Panel>
        <Button Width="72" Height="72" CornerRadius="36" Padding="0"
                IsVisible="{Binding !IsRunning}"
                Command="{Binding StartStopCommand}"
                Background="{DynamicResource StopwatchAccentBrush}"
                Foreground="White">
          <mi:MaterialIcon Kind="Play" Width="32" Height="32" />
        </Button>
        <Button Width="72" Height="72" CornerRadius="36" Padding="0"
                IsVisible="{Binding IsRunning}"
                Command="{Binding StartStopCommand}"
                Background="{DynamicResource StopwatchAccentBrush}"
                Foreground="White">
          <mi:MaterialIcon Kind="Stop" Width="32" Height="32" />
        </Button>
      </Panel>

      <!-- Undo -->
      <Button Classes="Outlined" Width="56" Height="56" CornerRadius="28" Padding="0"
              IsVisible="{Binding CanUndo}"
              Command="{Binding UndoCommand}">
        <mi:MaterialIcon Kind="Undo" Width="24" Height="24" />
      </Button>
      <Border Width="56" Height="56" IsVisible="{Binding !CanUndo}" />

    </StackPanel>

    <!-- Rundenzeiten -->
    <Panel Grid.Row="2" Margin="16,8,16,0">

      <!-- Empty State -->
      <StackPanel IsVisible="{Binding !HasLaps}"
                  VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="8">
        <mi:MaterialIcon Kind="FlagCheckered" Width="48" Height="48"
                         Foreground="{DynamicResource TextMutedBrush}"
                         HorizontalAlignment="Center" />
        <TextBlock Text="{Binding NoLapsText}" Classes="BodyMedium"
                   Foreground="{DynamicResource TextMutedBrush}"
                   HorizontalAlignment="Center" />
      </StackPanel>

      <!-- Rundenliste -->
      <DockPanel IsVisible="{Binding HasLaps}">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="6" Margin="0,0,0,8">
          <mi:MaterialIcon Kind="FlagCheckered" Width="16" Height="16"
                           Foreground="{DynamicResource StopwatchAccentBrush}" />
          <TextBlock Text="{Binding LapTimesText}" Classes="TitleSmall"
                     Foreground="{DynamicResource StopwatchAccentBrush}" />
        </StackPanel>

        <ScrollViewer>
          <ItemsControl ItemsSource="{Binding Laps}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="models:StopwatchLap">
                <Border Classes="Card" Margin="0,0,0,4" Padding="12,8">
                  <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Runden-Badge mit Cyan-Akzent -->
                    <Border Grid.Column="0"
                            Background="{DynamicResource StopwatchAccentBrush}"
                            CornerRadius="12" Padding="8,4" VerticalAlignment="Center"
                            Margin="0,0,12,0">
                      <TextBlock Text="{Binding LapNumber, StringFormat='#{0}'}"
                                 FontSize="12" FontWeight="Bold" Foreground="White" />
                    </Border>

                    <TextBlock Grid.Column="1" Text="{Binding LapTimeFormatted}"
                               FontSize="18" FontWeight="Medium"
                               VerticalAlignment="Center" />

                    <TextBlock Grid.Column="2" Text="{Binding TotalTimeFormatted}"
                               FontSize="14"
                               Foreground="{DynamicResource TextMutedBrush}"
                               VerticalAlignment="Center" />
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </DockPanel>

    </Panel>

  </Grid>

</UserControl>
