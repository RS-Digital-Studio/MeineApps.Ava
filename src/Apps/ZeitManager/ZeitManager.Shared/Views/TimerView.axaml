<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ZeitManager.ViewModels"
             xmlns:models="using:ZeitManager.Models"
             xmlns:mi="using:Material.Icons.Avalonia"
             xmlns:controls="using:MeineApps.UI.Controls"
             x:Class="ZeitManager.Views.TimerView"
             x:DataType="vm:TimerViewModel">

  <UserControl.Styles>
    <!-- Pulsier-Animation für laufende Timer -->
    <Style Selector="Border.TimerRunningPulse">
      <Style.Animations>
        <Animation Duration="0:0:2" IterationCount="INFINITE">
          <KeyFrame Cue="0%"><Setter Property="Opacity" Value="1" /></KeyFrame>
          <KeyFrame Cue="50%"><Setter Property="Opacity" Value="0.6" /></KeyFrame>
          <KeyFrame Cue="100%"><Setter Property="Opacity" Value="1" /></KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>
  </UserControl.Styles>

  <Grid RowDefinitions="Auto,*">

    <!-- Quick Timer Chips -->
    <Border Grid.Row="0" Margin="16,16,16,8" Padding="12"
            Background="{DynamicResource SurfaceBrush}" CornerRadius="12">
      <StackPanel Spacing="10">
        <StackPanel Orientation="Horizontal" Spacing="6">
          <mi:MaterialIcon Kind="TimerSand" Width="16" Height="16"
                           Foreground="{DynamicResource TimerAccentBrush}" />
          <TextBlock Text="{Binding QuickTimerText}" Classes="TitleSmall"
                     Foreground="{DynamicResource TimerAccentBrush}" />
        </StackPanel>
        <WrapPanel Orientation="Horizontal">
          <!-- 1 min - Blitz -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="1">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="FlashOutline" Width="16" Height="16" />
              <TextBlock Text="1 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 5 min - Kaffee -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="5">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="CoffeeOutline" Width="16" Height="16" />
              <TextBlock Text="5 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 10 min - Sanduhr -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="10">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="TimerSand" Width="16" Height="16" />
              <TextBlock Text="10 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 15 min - Pause -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="15">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="FoodAppleOutline" Width="16" Height="16" />
              <TextBlock Text="15 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
          <!-- 30 min - Workout -->
          <Button Margin="0,0,8,8" Padding="10,6" CornerRadius="16"
                  Background="{DynamicResource CardBrush}" Foreground="{DynamicResource TimerAccentBrush}"
                  BorderBrush="{DynamicResource TimerAccentBrush}" BorderThickness="1.5"
                  Command="{Binding AddQuickTimerCommand}" CommandParameter="30">
            <StackPanel Orientation="Horizontal" Spacing="6">
              <mi:MaterialIcon Kind="WeightLifter" Width="16" Height="16" />
              <TextBlock Text="30 min" FontWeight="SemiBold" FontSize="13" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
        </WrapPanel>
      </StackPanel>
    </Border>

    <!-- Timer List / Empty State -->
    <Panel Grid.Row="1">

      <!-- Empty State -->
      <StackPanel IsVisible="{Binding !HasTimers}"
                  VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
        <mi:MaterialIcon Kind="TimerSandEmpty" Width="64" Height="64"
                         Foreground="{DynamicResource TextMutedBrush}"
                         HorizontalAlignment="Center" />
        <TextBlock Text="{Binding NoTimersText}" Classes="TitleMedium"
                   Foreground="{DynamicResource TextMutedBrush}"
                   HorizontalAlignment="Center" />
        <TextBlock Text="{Binding CreateTimerText}" Classes="BodyMedium"
                   Foreground="{DynamicResource TextMutedBrush}"
                   HorizontalAlignment="Center" TextWrapping="Wrap"
                   TextAlignment="Center" />
      </StackPanel>

      <!-- Timer List -->
      <ScrollViewer IsVisible="{Binding HasTimers}">
        <ItemsControl ItemsSource="{Binding Timers}" Margin="16,0">
          <ItemsControl.ItemTemplate>
            <DataTemplate x:DataType="models:TimerItem">
              <Border Classes="Card" Margin="0,0,0,8" Padding="12">
                <Grid ColumnDefinitions="Auto,*,Auto">

                  <!-- Fortschrittsring -->
                  <Panel Grid.Column="0" Margin="0,0,16,0" VerticalAlignment="Center">
                    <controls:CircularProgress Width="64" Height="64"
                        Value="{Binding ProgressFraction}"
                        StrokeWidth="5"
                        TrackBrush="{DynamicResource BorderSubtleBrush}"
                        StrokeBrush="{DynamicResource TimerAccentBrush}" />
                    <!-- Pulsierender Amber-Punkt bei laufendem Timer -->
                    <Border Classes="TimerRunningPulse"
                            IsVisible="{Binding IsRunning}"
                            Width="10" Height="10" CornerRadius="5"
                            Background="{DynamicResource TimerAccentBrush}"
                            HorizontalAlignment="Center" VerticalAlignment="Center" />
                    <!-- Fertiges Häkchen -->
                    <mi:MaterialIcon Kind="Check" Width="24" Height="24"
                                     IsVisible="{Binding IsFinished}"
                                     Foreground="{DynamicResource SuccessBrush}"
                                     HorizontalAlignment="Center" VerticalAlignment="Center" />
                    <!-- Pause-Icon -->
                    <mi:MaterialIcon Kind="Pause" Width="20" Height="20"
                                     IsVisible="{Binding IsPaused}"
                                     Foreground="{DynamicResource TextMutedBrush}"
                                     HorizontalAlignment="Center" VerticalAlignment="Center" />
                  </Panel>

                  <!-- Timer Info -->
                  <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="2">
                    <TextBlock Text="{Binding Name}" Classes="TitleSmall"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                    <TextBlock Text="{Binding RemainingTimeFormatted}"
                               FontSize="28" FontWeight="Light"
                               Foreground="{DynamicResource TextPrimaryBrush}" />
                  </StackPanel>

                  <!-- Steuerungs-Buttons -->
                  <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4"
                              VerticalAlignment="Center">
                    <!-- Start -->
                    <Button Classes="Icon" MinWidth="44" MinHeight="44"
                            IsVisible="{Binding IsNotRunning}"
                            Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).StartTimerCommand}"
                            CommandParameter="{Binding}">
                      <mi:MaterialIcon Kind="Play" Width="22" Height="22"
                                       Foreground="{DynamicResource TimerAccentBrush}" />
                    </Button>
                    <!-- Pause -->
                    <Button Classes="Icon" MinWidth="44" MinHeight="44"
                            IsVisible="{Binding IsRunning}"
                            Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).PauseTimerCommand}"
                            CommandParameter="{Binding}">
                      <mi:MaterialIcon Kind="Pause" Width="22" Height="22"
                                       Foreground="{DynamicResource TimerAccentBrush}" />
                    </Button>
                    <!-- Stop -->
                    <Button Classes="Icon" MinWidth="44" MinHeight="44"
                            Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).StopTimerCommand}"
                            CommandParameter="{Binding}">
                      <mi:MaterialIcon Kind="Stop" Width="20" Height="20"
                                       Foreground="{DynamicResource TextMutedBrush}" />
                    </Button>
                    <!-- Delete -->
                    <Button Classes="Icon" MinWidth="44" MinHeight="44"
                            Command="{Binding $parent[ItemsControl].((vm:TimerViewModel)DataContext).DeleteTimerCommand}"
                            CommandParameter="{Binding}">
                      <mi:MaterialIcon Kind="Delete" Width="18" Height="18"
                                       Foreground="{DynamicResource ErrorBrush}" />
                    </Button>
                  </StackPanel>

                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </ScrollViewer>

      <!-- FAB: Create Timer -->
      <Button Command="{Binding ShowCreateTimerCommand}"
              HorizontalAlignment="Right" VerticalAlignment="Bottom"
              Margin="0,0,24,24" Width="56" Height="56"
              CornerRadius="28" Padding="0"
              Background="{DynamicResource TimerAccentBrush}"
              Foreground="White">
        <mi:MaterialIcon Kind="Plus" Width="28" Height="28" />
      </Button>

    </Panel>

    <!-- Create Timer Dialog Overlay -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsCreatingTimer}"
            Background="#80000000">
      <Border Classes="Card" Margin="32"
              VerticalAlignment="Center" HorizontalAlignment="Stretch"
              MaxWidth="400">
        <StackPanel Spacing="16">
          <TextBlock Text="{Binding NewTimerTitleText}" Classes="HeadlineMedium" />

          <TextBox Text="{Binding NewTimerName, Mode=TwoWay}"
                   Watermark="{Binding $parent[UserControl].((vm:TimerViewModel)DataContext).CreateTimerText}" />

          <!-- Time Pickers (Drum Wheel) -->
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4">
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerHours}" Minimum="0" Maximum="23" FormatString="D2" />
              <TextBlock Text="{Binding $parent[UserControl].((vm:TimerViewModel)DataContext).MinutesText, FallbackValue='h'}"
                         Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
            <TextBlock Text=":" FontSize="28" FontWeight="Medium" VerticalAlignment="Center"
                       Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" />
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerMinutes}" Minimum="0" Maximum="59" FormatString="D2" />
              <TextBlock Text="min" Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
            <TextBlock Text=":" FontSize="28" FontWeight="Medium" VerticalAlignment="Center"
                       Foreground="{DynamicResource TextMutedBrush}" Margin="0,0,0,16" />
            <StackPanel Spacing="2">
              <controls:WheelPicker Value="{Binding NewTimerSeconds}" Minimum="0" Maximum="59" FormatString="D2" />
              <TextBlock Text="s" Classes="Caption" HorizontalAlignment="Center"
                         Foreground="{DynamicResource TextMutedBrush}" />
            </StackPanel>
          </StackPanel>

          <!-- Dialog Buttons -->
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding CancelText}"
                    Command="{Binding HideCreateTimerCommand}" />
            <Button Classes="Primary" Content="{Binding CreateText}"
                    Command="{Binding CreateTimerCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

    <!-- Delete Confirmation Overlay -->
    <Border Grid.Row="0" Grid.RowSpan="2"
            IsVisible="{Binding IsDeleteConfirmVisible}"
            Background="#80000000">
      <Border Classes="Card" Margin="32"
              VerticalAlignment="Center" HorizontalAlignment="Stretch"
              MaxWidth="350">
        <StackPanel Spacing="16">
          <TextBlock Text="{Binding ConfirmDeleteTitleText}" Classes="TitleLarge" />
          <TextBlock Text="{Binding ConfirmDeleteMessageText}" Classes="BodyMedium"
                     TextWrapping="Wrap" />
          <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Classes="Text" Content="{Binding NoText}"
                    Command="{Binding CancelDeleteTimerCommand}" />
            <Button Classes="Primary" Content="{Binding YesText}"
                    Command="{Binding ConfirmDeleteTimerCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>
    </Border>

  </Grid>

</UserControl>
